<%- partial('../cms/_navtabs') %>

<div class="col-sm-8 col-sm-offset-2">
  <div class="panel panel-default">
    <div class="panel-heading">
      Cagegory
    </div>
    <div class="panel-body category">
      <div class="btn-group category" v-for="category in categories">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          {{category.text}} <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a>{{category.key}}</a></li>
          <li><a v-on:click="onDelete(category._id)">删除</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="panel panel-default">
    <div class="panel-heading">
      添加
    </div>
    <div class="panel-body">
      <div class='form-group'>
        <input class='form-control' id='key' name='key' size='30' type='test' v-model="key" placeholder=""/>
      </div>
      <div class='form-group'>
        <input class='form-control' id='value' name='value' size='30' type='value' v-model="value" placeholder=""/>
      </div>
      <button class="btn btn-default" v-on:click="onAdd">添加</button>
    </div>
  </div>
</div>
<script>

  var vue = new Vue({
    el: '#app',
    data: {
      categories: [],
      key: '',
      value: ''
    },
    methods: {
      getCategories: function() {
        $.get('/cms/categories', function (result) {
          if (!result.success) {
            return;
          }

          vue.categories = result.categories;
        });
      },
      onDelete: function(id) {
        $.post('/cms/category/' + id + '/delete', {cid: id}, function (result) {
          if (!result.success) {
            console.log(result.message);
            return;
          }

          var index = _.findIndex(vue.categories, function(category) {
            if (category._id === id) return true;
          });

          vue.categories.$remove(vue.categories[index]);
        });
      },
      onAdd: function() {
        $.post('/cms/category/add', { _csrf: $('#_csrf').val(), key: vue.key, text: vue.value}, function (result) {
          if (!result.success) {
            console.log(result.message);
            return;
          }

          vue.categories.push(result.category);
        });
      }
    }
  });

  vue.getCategories();
</script>