<div class="col-sm-8 col-sm-offset-2">
  <input type="hidden" id="topic-id" value="<%= typeof(topic._id) !== 'undefined' ? topic._id : '' %>"/>
  <div class='header topic_header'>
    <h1 class="topic_full_title">
      <%= topic.title %>
    </h1>
    <div class="changes">
      <span>
        发布于 <%= topic.create_at_ago() %>
      </span>
      <span>
        作者 <a href="/user/<%= topic.author.loginname %>"><%= topic.author.loginname %></a>
      </span>
      <span>
        <%= topic.visit_count %> 次浏览
      </span>
      <% if (topic.create_at_ago() != topic.update_at_ago()) { %>
        <span>
          最后一次编辑是 <%= topic.update_at_ago() %>
        </span>
      <% } %>
      <% if (topic.tab) { %>
        <span> 来自 <%= topic.tabName %></span>
      <%}%>
    </div>
  </div>
  <div class='nongshuoshu-body'>
    <%- markdown(topic.linkedContent) %>
  </div>


  <div class="panel panel-default">
    <div class="panel-heading">
      评论
    </div>
    <div class="panel-body">
      <div v-if="replies">
        <div class="reply-panel" v-for="reply in replies">
          <div class="reply-user">
            <strong>{{reply.author.loginname}}</strong><span class="reply-user-time">{{reply.create_at_ago}}</span>
            <div class="btn-toolbar pull-right" role="toolbar" aria-label="...">
              <div class="btn-group" role="group" aria-label="...">
                <button v-if="currentUserId === reply.author._id"
                        type="button"
                        class="btn btn-default btn-sm"
                  v-on:click="onReplyReply(reply._id, reply.author.loginname)">
                  <span class="glyphicon glyphicon-share-alt" aria-hidden="true"></span>
                </button>
                <button v-if="currentUserId === reply.author._id"
                        type="button"
                        class="btn btn-default btn-sm"
                        v-on:click="onDeleteReply(reply._id)">
                  <span class="glyphicon glyphicon-remove" aria-hidden="true" data-replyid="{{reply._id}}"></span>
                </button>
                <button v-if="currentUserId === reply.author._id"
                        type="button" class="btn btn-default btn-sm" v-on:click="onEditReply(reply._id, reply.content)">
                  <span class="glyphicon glyphicon-edit" aria-hidden="true" data-replyid="{{reply._id}}"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="reply-content">
            {{reply.content}}
          </div>
        </div>
      </div>
      <div v-else>没有评论</div>
    </div>
  </div>


  <% if (current_user && typeof(topic) !== 'undefined') { %>
  <div class='panel panel-default'>
    <div class='panel-heading'>
      <span class='col_fade'>添加回复</span>
    </div>
    <div class='panel-body reply'>
      <form id='reply_form' action='/<%= topic._id %>/reply' method='post'>
        <div class='markdown_editor in_editor'>
          <div class='markdown_in_editor'>
            <textarea class='editor' name='r_content' rows='8'></textarea>
            <input class='btn btn-primary submit_btn'
                   type="submit"
                   data-loading-text="回复中.."
                   value="回复<%= topic.lock ? '(此主题已锁定)' : ''%>" <%= topic.lock ? 'disabled="disabled"' :''%>>
          </div>
        </div>
        <input type='hidden' name='_csrf' id="_csrf" value='<%= csrf %>'/>
      </form>
    </div>
  </div>
  <% } %>
</div>

<div class="replies_history">
  <div class="inner_content"></div>
  <div class="anchor"></div>
</div>

<!-- 预览模态对话框 -->
<div class="modal fade" id="preview-modal">
  <div class="modal-body" style="max-height: initial;">
    <img src="" alt="点击内容或者外部自动关闭图片预览" id="preview-image">
  </div>
</div>

<!-- markdown editor -->
<%- partial('../includes/editor') %>
<script>
  $(document).ready(function () {

    var editor = new Editor();
    editor.render($('.editor')[0]);

    var vue = new Vue({
      el: '#app',
      data: {
        currentUserId: "",
        topicId: '',
        replies: []
      },
      methods: {
        getReplies: function() {
          $.get('/' + vue.topicId + '/replies', function (result) {
            if (!result.success) {
              alert('xxx');
              return;
            }

            console.log(result.replies);
            vue.replies = result.replies;
          });
        },
        onReplyReply: function (replyId, loginname) {
          var editorDialog = new EditorDialog();
          var atUser = '@' + loginname + ' ';
          editorDialog.init('编辑', atUser);
          editorDialog.show(function (editedContent) {
            if (editedContent) {
              $.post('/' + vue.topicId + '/reply', {reply_id: replyId, content: editedContent}, function (result) {
                if (!result.success) {
                  vue.errorMsg = result.message;
                  return;
                }

                vue.replies.push(result.reply);
              });
            }
          });
        },
        onEditReply: function(replyId, content) {
          var editorDialog = new EditorDialog();
          editorDialog.init('编辑', content);
          editorDialog.show(function (editedContent) {
            if (editedContent) {
              $.post('/reply/' + replyId + '/edit', {reply_id: replyId, content: editedContent}, function (result) {
                if (!result.success) {
                  vue.errorMsg = result.message;
                  return;
                }

                var index = _.findIndex(vue.replies, function(reply) {
                  if (reply._id === replyId) return true;
                });

                vue.replies[index].content = editedContent;
              });
            }
          });
        },
        onDeleteReply: function(replyId) {
          $.post('/reply/' + replyId + '/delete', {reply_id: replyId}, function (result) {
            if (!result.success) {
              vue.errorMsg = result.message;
              return;
            }

            var index = _.findIndex(vue.replies, function(reply) {
              if (reply._id === replyId) return true;
            });

            vue.replies.$remove(vue.replies[index]);
          });
        }
      }
    });

    vue.topicId = '<%= typeof(topic) !== "undefined" && topic ? topic._id : "" %>';
    vue.currentUserId = '<%= typeof(current_user) !== "undefined" ? current_user._id : "" %>';
    vue.getReplies();
  });

</script>